{
  "version": "THYREN_FLOW_QUIZ_1.1",
  "flow_order": ["Q1","Q2","Q2_plus","Q3","Q4","Q4b","Q5","Q6","Q7","Q7b","Q8","Q8b","Q9","Q9b","Q10","Q10b","Q11","RESULT"],
  "nodes": {
    "Q1": {
      "id": "Q1",
      "type": "open",
      "text": "C’est parti !\nJe vais te poser quelques questions ciblées (environ 2 minutes) afin d’analyser tes besoins et ton profil, et déterminer si nos cures sont adaptées pour toi.\nPour commencer, quel est ton prénom ?",
      "next": "Q2",
      "meta": { "capture": "first_name" }
    },
    "Q2": {
      "id": "Q2",
      "type": "choices",
      "text": "Enchanté {{first_name}}. Quel est ton sexe biologique ?",
      "choices": ["Femme","Homme"],
      "next_map": { "Femme": "Q2_plus", "Homme": "Q3" },
      "meta": { "capture": "sex" }
    },
    "Q2_plus": {
      "id": "Q2_plus",
      "type": "choices",
      "text": "{{AI_PREV_INTERPRETATION}}\n\nEs-tu enceinte ou allaitante ?",
      "choices": ["Oui","Non"],
      "next": "Q3",
      "meta": { "capture": "enceinte" }
    },
    "Q3": {
      "id": "Q3",
      "type": "choices",
      "text": "{{AI_PREV_INTERPRETATION}}\n\nQuel est ton âge ?",
      "choices": ["Moins de 30 ans","30-45 ans","45-60 ans","Plus de 60 ans"],
      "next": "Q4",
      "meta": { "capture": "age_band" }
    },
    "Q4": {
      "id": "Q4",
      "type": "choices",
      "text": "{{AI_PREV_INTERPRETATION}}\n\nAs-tu une condition médicale ou une allergie à signaler ?",
      "choices": ["Tout va bien","J’ai des allergies ou une condition médicale à signaler"],
      "next_map": { "Tout va bien": "Q5", "J’ai des allergies ou une condition médicale à signaler": "Q4b" },
      "meta": { "capture": "safety_flag" }
    },
    "Q4b": {
      "id": "Q4b",
      "type": "open",
      "text": "Merci de préciser tes allergies ou ta condition médicale.",
      "next": "Q5",
      "meta": { "capture": "safety_details" }
    },
    "Q5": {
      "id": "Q5",
      "type": "open",
      "text": "{{AI_PREV_INTERPRETATION}}\n\nLe plus important, raconte-moi ce qui te gêne en ce moment, ce que tu ressens et ce que tu aimerais améliorer. Prends ton temps, sois précis : tout peut m’aider.",
      "next": "Q6",
      "meta": { "capture": "plainte_client" }
    },
    "Q6": {
      "id": "Q6",
      "type": "choices",
      "text": "{{AI_PREV_INTERPRETATION}}\n\n Si tu devais te concentrer sur un seul problème, lequel serait-ce ?",
      "choices": [],
      "next": "Q7",
      "meta": { "capture": "priorité" },
      "ai": {
        "goal": "Générer des choices personnalisés (max 10) à partir du texte libre de Q5.",
        "inputs": ["plainte_client","sex","age_band","enceinte","safety_flag","safety_details"],
        "rules": [
          "Créer entre 5 et 10 choices maximum.",
          "Chaque choice doit être court (2 à 6 mots), concret et compréhensible.",
          "Reprendre les thèmes/symptômes réellement mentionnés dans plainte_client (pas de catégories génériques).",
          "Éviter les doublons et regrouper les synonymes.",
          "Si plainte_client est flou, proposer des choices de clarification basés sur les mots présents.",
          "Ajouter TOUJOURS en dernier \"Autre / préciser\"."
        ],
        "output_format": "Retourner une réponse JSON de type \"question\" contenant \"choices\" (array) rempli."
      }
    },
    "Q7": {
      "id": "Q7",
      "type": "choices",
      "text": "{{AI_PREV_INTERPRETATION}}\n\n {{AI_Q7_TEXT}}",
      "choices": [],
      "next_map": { "Autre / préciser": "Q7b" },
      "next": "Q8",
      "meta": { "capture": "detail_1" },
      "ai": {
        "goal": "Générer des choices cliquables (max 8) qui répondent à la question personnalisée {{AI_Q7_TEXT}}.",
        "inputs": ["plainte_client","priorité","sex","age_band","enceinte","safety_flag","safety_details"],
        "rules": [
          "Créer 4 à 8 choices maximum.",
          "Chaque choice doit être court (2 à 6 mots), concret et compréhensible.",
          "Les choices doivent correspondre à la question {{AI_Q7_TEXT}} et au contexte (plainte_client + priorité).",
          "Éviter les doublons et regrouper les synonymes.",
          "Ajouter TOUJOURS en dernier \"Autre / préciser\"."
        ],
        "output_format": "Retourner une réponse JSON de type \"question\" contenant \"choices\" (array) rempli."
      }
    },
    "Q7b": {
      "id": "Q7b",
      "type": "open",
      "text": "OK. Peux-tu préciser en une phrase ?",
      "next": "Q8",
      "meta": { "capture": "detail_1_free" }
    },
    "Q8": {
      "id": "Q8",
      "type": "choices",
      "text": "{{AI_PREV_INTERPRETATION}}\n\n {{AI_Q8_TEXT}}",
      "choices": [],
      "next_map": { "Autre / préciser": "Q8b" },
      "next": "Q9",
      "meta": { "capture": "detail_2" },
      "ai": {
        "goal": "Générer des choices cliquables (max 8) qui répondent à la question personnalisée {{AI_Q8_TEXT}}.",
        "inputs": ["plainte_client","priorité","detail_1","detail_1_free","sex","age_band","enceinte","safety_flag","safety_details"],
        "rules": [
          "Créer 4 à 8 choices maximum.",
          "Chaque choice doit être court (2 à 6 mots), concret et compréhensible.",
          "Les choices doivent correspondre à la question {{AI_Q8_TEXT}} et au contexte (plainte_client + priorité + réponses précédentes).",
          "Éviter les doublons et regrouper les synonymes.",
          "Ajouter TOUJOURS en dernier \"Autre / préciser\"."
        ],
        "output_format": "Retourner une réponse JSON de type \"question\" contenant \"choices\" (array) rempli."
      }
    },
    "Q8b": {
      "id": "Q8b",
      "type": "open",
      "text": "OK. Peux-tu préciser en une phrase ?",
      "next": "Q9",
      "meta": { "capture": "detail_2_free" }
    },
    "Q9": {
      "id": "Q9",
      "type": "choices",
      "text": "{{AI_PREV_INTERPRETATION}}\n\n {{AI_Q9_TEXT}}",
      "choices": [],
      "next_map": { "Autre / préciser": "Q9b" },
      "next": "Q10",
      "meta": { "capture": "detail_3" },
      "ai": {
        "goal": "Générer des choices cliquables (max 8) qui répondent à la question personnalisée {{AI_Q9_TEXT}}.",
        "inputs": ["plainte_client","priorité","detail_1","detail_1_free","detail_2","detail_2_free","sex","age_band","enceinte","safety_flag","safety_details"],
        "rules": [
          "Créer 4 à 8 choices maximum.",
          "Chaque choice doit être court (2 à 6 mots), concret et compréhensible.",
          "Les choices doivent correspondre à la question {{AI_Q9_TEXT}} et au contexte (plainte_client + priorité + réponses précédentes).",
          "Éviter les doublons et regrouper les synonymes.",
          "Ajouter TOUJOURS en dernier \"Autre / préciser\"."
        ],
        "output_format": "Retourner une réponse JSON de type \"question\" contenant \"choices\" (array) rempli."
      }
    },
    "Q9b": {
      "id": "Q9b",
      "type": "open",
      "text": "OK. Peux-tu préciser en une phrase ?",
      "next": "Q10",
      "meta": { "capture": "detail_3_free" }
    },
    "Q10": {
      "id": "Q10",
      "type": "choices",
      "text": "{{AI_PREV_INTERPRETATION}}\n\n {{AI_Q10_TEXT}}",
      "choices": [],
      "next_map": { "Autre / préciser": "Q10b" },
      "next": "Q11",
      "meta": { "capture": "detail_4" },
      "ai": {
        "goal": "Générer des choices cliquables (max 8) qui répondent à la question personnalisée {{AI_Q10_TEXT}}.",
        "inputs": ["plainte_client","priorité","detail_1","detail_1_free","detail_2","detail_2_free","detail_3","detail_3_free","sex","age_band","enceinte","safety_flag","safety_details"],
        "rules": [
          "Créer 4 à 8 choices maximum.",
          "Chaque choice doit être court (2 à 6 mots), concret et compréhensible.",
          "Les choices doivent correspondre à la question {{AI_Q10_TEXT}} et au contexte (plainte_client + priorité + réponses précédentes).",
          "Éviter les doublons et regrouper les synonymes.",
          "Ajouter TOUJOURS en dernier \"Autre / préciser\"."
        ],
        "output_format": "Retourner une réponse JSON de type \"question\" contenant \"choices\" (array) rempli."
      }
    },
    "Q10b": {
      "id": "Q10b",
      "type": "open",
      "text": "OK. Peux-tu préciser en une phrase ?",
      "next": "Q11",
      "meta": { "capture": "detail_4_free" }
    },
    "Q11": {
      "id": "Q11",
      "type": "open",
      "text": "{{AI_PREV_INTERPRETATION}}\n\n Peux-tu me partager ton adresse e-mail pour t’envoyer le récapitulatif de tes résultats et recommandations ?",
      "next_on_valid": "RESULT",
      "next_on_skip": "RESULT",
      "validation": { "type": "email_regex", "pattern": "^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$" },
      "meta": { "capture": "email" }
    },
    "RESULT": { "id": "RESULT", "type": "terminal", "action": "generate_report" }
  },
  "engine_hints": {
    "state_model": { "current_id": "string", "answers": "map", "history": "array" },
    "advance_rule": "Toujours suivre nodes[current_id].next ou next_map."
  }
}
